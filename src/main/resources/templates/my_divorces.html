<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>My divorces</title>
</head>
<body>
<div class="cover-container d-flex h-100 p-3 mx-auto flex-column">

<main role="main" layout:fragment ="main-content" class="container">
    <h2>My divorces<small>previous and in progress</small></h2>

    <form name="myDivorces">
        <ul class="responsive-table">
            <li class="table-header">
                <div class="col col-1">Divorce ID</div>
                <div class="col col-1">Created at</div>
                <div class="col col-1">Child support</div>
                <div class="col col-1">Restore name</div>
                <div class="col col-1">Status</div>
                <div class="col col-1">Notarial Action Id</div>
                <div class="col col-1" th:if="${#authorization.expression('hasAnyRole(''LAWYER'', ''SPOUSE'')')}">Approve</div>
                <div class="col col-1" th:if="${#authorization.expression('hasRole(''LAWYER'')')}">Cancel</div>
                <div class="col col-1" th:if="${#authorization.expression('hasRole(''NOTARY'')')}">Accept</div>
            </li>
            <li class="table-row" th:each="divorce : ${divorces}">
                <div class="col col-1" data-label="Divorce ID" th:text="${divorce.getId()}"></div>
                <div class="col col-1" data-label="Created at" th:text="${divorce.getCreated_at()}"></div>
                <div class="col col-1" data-label="Child support" th:text="${divorce.getChildSupport()}"></div>
                <div class="col col-1" data-label="Restore name" th:text="${divorce.getRestoreName()}"></div>
                <div class="col col-1" data-label="Status" th:text="${divorce.getStatus()}"></div>
                <div class="col col-1" data-label="Notarial Action Id" th:text="${divorce.getNotarialActionId()}"></div>

                <div th:if="${#authorization.expression('hasAnyRole(''LAWYER'', ''SPOUSE'')')} and ${divorce.getStatus().toLowerCase().equals('pending')}">
                    <button type="submit" th:id="${divorce.getId()}"
                            name="acceptDivorce"><i class="remove user icon"></i>
                        Accept</button>
                </div>
                <div th:if="${#authorization.expression('hasRole(''LAWYER'')')} and ${divorce.getStatus().toLowerCase().equals('pending')}">
                    <button type="submit" th:id="${divorce.getId()}"
                            name="cancelDivorce"><i class="remove user icon"></i>
                        Cancel</button>
                </div>
                <div th:if="${#authorization.expression('hasRole(''NOTARY'')')} and ${divorce.getStatus().toLowerCase().equals('pending')}">
                    <button type="submit" th:id="${divorce.getId()}"
                            name="approveDivorce"><i class="remove user icon"></i>
                        Approve</button>
                </div>
                <div th:if="${#authorization.expression('hasAnyRole(''LAWYER'', ''SPOUSE'')')} and ${divorce.getStatus().toLowerCase().equals('approved')}">
                    Divorce Filled
                </div>
                <div th:if="${#authorization.expression('hasRole(''LAWYER'')')} and ${divorce.getStatus().toLowerCase().equals('approved')}">
                    Divorce Filled
                </div>
                <div th:if="${#authorization.expression('hasRole(''NOTARY'')')} and ${divorce.getStatus().toLowerCase().equals('approved')}">
                    Divorce Filled
                </div>
            </li>
        </ul>
    </form>

    <div class="alert" name="alert">

    </div>
</main>

    <script type="text/javascript">
        $("[name='myDivorces']").on("submit", (e) => {
            e.preventDefault();

            const urlCall = "/divorce/deleteDivorce/" + $("[name='cancelDivorce']").attr("id");
            $.ajax({
                url: urlCall,
                type: "POST",
                success: function (result) {
                    createAlert(result, "Success")
                    location.reload();
                },
                error: function (xhr, exception) {
                    switch (xhr.status) {
                        case 404:
                            createAlert(xhr.responseText, "Warning")
                            break;
                        case 403:
                            createAlert(xhr.responseText, "Warning")
                            break;
                        default:
                            createAlert("Something went wrong. Try again in a bit", "Warning")
                    }
                }
            });
        })

        $("[name='myDivorces']").on("submit", (e) => {
            e.preventDefault();
            const urlCall = "/divorce/acceptDivorce/" + $("[name='acceptDivorce']").attr("id");
            $.ajax({
                url: urlCall,
                type: "POST",
                success: function (result) {
                    createAlert(result, "Success")
                    location.reload();
                },
                error: function (xhr, exception) {
                    switch (xhr.status) {
                        case 404:
                            createAlert(xhr.responseText, "Warning")
                            break;
                        case 403:
                            createAlert(xhr.responseText, "Warning")
                            break;
                        case 409:
                            createAlert(xhr.responseText, "Warning")
                            break;
                        default:
                            createAlert("Something went wrong. Try again in a bit", "Warning")
                    }
                }
            });
        })

        $("[name='myDivorces']").on("submit", (e) =>{
            e.preventDefault();
            const urlCall = "/divorce/approveDivorce/" + $("[name='approveDivorce']").attr("id");
            $.ajax({
                url: urlCall,
                type: "POST",
                success: function (result) {
                    createAlert(result, "Success")
                    location.reload();
                },
                error: function (xhr, exception) {
                    switch (xhr.status) {
                        case 404:
                            createAlert(xhr.responseText, "Warning")
                            break;
                        case 403:
                            createAlert(xhr.responseText, "Warning")
                            break;
                        default:
                            createAlert("Something went wrong. Try again in a bit", "Warning")
                    }
                }
            });
        })

        function createAlert(message, type){
            const alert = $("[name='alert']");
            alert.addClass("alert " + type);
            alert.text(message);

            setTimeout(() => {
                alert.removeClass("alert " + type);
                alert.text("");
            }, 3000);
        }
    </script>
</div>
</body>
</html>