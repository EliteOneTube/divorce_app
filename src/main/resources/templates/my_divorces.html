<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>My divorces</title>
</head>
<body>

<div layout:fragment ="main-content">
    <h1>My divorces</h1>

    <form name="My divorces">
        <table class="center" border="1" style="width:68%">
            <th>Divorce ID</th>
            <th>Created at</th>
            <th>Child support</th>
            <th>Restore name</th>
            <th>Status</th>
            <th th:if="${#authorization.expression('hasAnyRole(''LAWYER'', ''SPOUSE'')')}">Approve</th>
            <th th:if="${#authorization.expression('hasRole(''LAWYER'')')}">Cancel</th>
            <th th:if="${#authorization.expression('hasRole(''NOTARY'')')}">Accept</th>
            <tr th:each="divorce : ${divorces}">
                <td th:text="${divorce.getId()}"></td>
                <td th:text="${divorce.getCreated_at()}"></td>
                <td th:text="${divorce.getChildSupport()}"/>
                <td th:text="${divorce.getRestoreName()}"/>
                <td th:text="${divorce.getStatus()}"/>
                <td th:if="${#authorization.expression('hasAnyRole(''LAWYER'', ''SPOUSE'')')} and ${divorce.getStatus().toLowerCase().equals('pending')}">
                    <button type="submit" th:id="${divorce.getId()}"
                            name="acceptDivorce"><i class="remove user icon"></i>
                        Accept</button>
                </td>
                <td th:if="${#authorization.expression('hasRole(''LAWYER'')')} and ${divorce.getStatus().toLowerCase().equals('pending')}">
                    <button type="submit" th:id="${divorce.getId()}"
                            name="cancelDivorce"><i class="remove user icon"></i>
                        Cancel</button>
                </td>
                <td th:if="${#authorization.expression('hasRole(''NOTARY'')')} and ${divorce.getStatus().toLowerCase().equals('pending')}">
                    <button type="submit" th:id="${divorce.getId()}"
                            name="approveDivorce"><i class="remove user icon"></i>
                        Approve</button>
                </td>
                <td th:if="${#authorization.expression('hasAnyRole(''LAWYER'', ''SPOUSE'')')} and ${divorce.getStatus().toLowerCase().equals('approved')}">
                    Divorce Filed
                </td>
                <td th:if="${#authorization.expression('hasRole(''LAWYER'')')} and ${divorce.getStatus().toLowerCase().equals('approved')}">
                    Divorce Filed
                </td>
                <td th:if="${#authorization.expression('hasRole(''NOTARY'')')} and ${divorce.getStatus().toLowerCase().equals('approved')}">
                    Divorce Filed
                </td>
            </tr>
        </table>
    </form>

    <script type="text/javascript">
        $("[name='cancelDivorce']").click(() => {
            const urlCall = "/divorce/deleteDivorce/" + $("[name='cancelDivorce']").attr("id");
            $.ajax({
                url: urlCall,
                type: "POST",
                success: function (result) {
                    alert("Divorce canceled");
                    location.reload();
                },
                error: function (error) {
                    alert(error.message)
                }
            });
        });

        $("[name='acceptDivorce']").click(() => {
            const urlCall = "/divorce/acceptDivorce/" + $("[name='acceptDivorce']").attr("id");
            $.ajax({
                url: urlCall,
                type: "POST",
                success: function (result) {
                    location.reload();
                },
                error: function (xhr, exception) {
                    switch (xhr.status) {
                        case 400:
                            alert("Divorce already accepted");
                            break;
                        case 401:
                            alert("You are not authorized to accept this divorce");
                            break;
                        case 403:
                            alert("You are not authorized to accept this divorce");
                            break;
                        case 404:
                            alert("Divorce not found");
                            break;
                        case 500:
                            alert("Internal server error");
                            break;
                        case 409:
                            alert("Divorce already accepted");
                            break;
                        default:
                            alert("Something went wrong");
                    }
                }
            });
        });

        $("[name='approveDivorce']").click(() => {
            const urlCall = "/divorce/approveDivorce/" + $("[name='approveDivorce']").attr("id");
            $.ajax({
                url: urlCall,
                type: "POST",
                success: function (result) {
                    alert("Divorce approved");
                    location.reload();
                },
                error: function (error) {
                    //get error message from result
                    alert(error.message)
                }
            });
        });
    </script>
</div>
</body>
</html>